{% extends "base.html" %}

{% block title %}{{ bounty.title }} - Falsifi{% endblock %}

{% block content %}
<div class="bounty-detail">
    <div class="bounty-header-detail">
        <div class="bounty-meta-header">
            <span class="badge badge-{{ bounty.status.value }}">{{ bounty.status.value|upper }}</span>
            <span class="category-tag">{{ bounty.category }}</span>
            {% if bounty.auto_adjudicate %}
            <span class="badge badge-ai">AI Adjudicated</span>
            {% endif %}
        </div>
        <h1>{{ bounty.title }}</h1>
        <div class="bounty-author">
            Posted by <strong>{{ bounty.creator.username }}</strong> 
            on {{ bounty.created_at.strftime('%Y-%m-%d') }}
        </div>
    </div>

    <div class="bounty-content">
        <div class="description-box">
            <h3>Description</h3>
            <div class="description-text">{{ bounty.description|nl2br }}</div>
        </div>

        <div class="bounty-actions">
            <div class="reward-box">
                <span class="reward-amount">{{ bounty.bounty_amount }}</span>
                <span class="reward-label">points reward</span>
            </div>
            {% if can_refute %}
            <a href="{{ url_for('submit_refutation', bounty_id=bounty.id) }}" class="btn-primary btn-large">Submit Refutation</a>
            {% elif is_owner %}
            <form method="POST" action="{{ url_for('close_bounty', bounty_id=bounty.id) }}" class="inline-form">
                <button type="submit" class="btn-danger" onclick="return confirm('Close this bounty? Unclaimed points will be returned.')">Close Bounty</button>
            </form>
            {% elif bounty.status.value != 'open' %}
            <span class="closed-badge">Bounty Closed</span>
            {% endif %}
        </div>
    </div>
</div>

<div class="refutations-section">
    <h2>Refutations ({{ refutations|length }})</h2>
    
    {% if avg_rating %}
    <div class="avg-rating">
        Average Rating: <strong>{{ "%.1f"|format(avg_rating) }}/10</strong>
    </div>
    {% endif %}

    {% for ref in refutations %}
    <div class="refutation-card">
        <div class="refutation-header">
            <div class="author-info">
                <strong>{{ ref.author.username }}</strong>
                <span class="reputation">{{ ref.author.reputation_score|int }} reputation</span>
            </div>
            <div class="refutation-meta">
                {% if ref.ai_score %}
                <span class="ai-score" title="AI Quality Score">AI: {{ ref.ai_score|int }}</span>
                {% endif %}
                <span class="status-badge status-{{ ref.adjudication_status.value }}">{{ ref.adjudication_status.value }}</span>
            </div>
        </div>

        <div class="refutation-content">
            {{ ref.content|nl2br }}
        </div>

        {% if ref.sources %}
        <div class="sources">
            <strong>Sources:</strong>
            <p>{{ ref.sources }}</p>
        </div>
        {% endif %}

        {% if ref.ai_feedback %}
        <div class="ai-feedback">
            <strong>AI Feedback:</strong>
            <p>{{ ref.ai_feedback }}</p>
        </div>
        {% endif %}

        {% if ref.creator_rating %}
        <div class="creator-rating">
            <strong>Creator Rating:</strong> {{ ref.creator_rating }}/10
            {% if ref.creator_feedback %}
            <p>"{{ ref.creator_feedback }}"</p>
            {% endif %}
        </div>
        {% endif %}

        {% if ref.reward_earned > 0 %}
        <div class="reward-earned">
            <span class="reward-badge">üèÜ Earned {{ ref.reward_earned }} points</span>
            {% if ref.bond_returned %}
            <span class="bond-badge">Bond returned</span>
            {% endif %}
        </div>
        {% endif %}

        {% if is_owner and not ref.creator_rating %}
        <div class="rate-section">
            <form method="POST" action="{{ url_for('rate_refutation', refutation_id=ref.id) }}" class="rate-form">
                <div class="form-row">
                    <label>Rate this refutation (1-10):</label>
                    <input type="number" name="rating" min="1" max="10" value="5" required>
                </div>
                <div class="form-row">
                    <label>Feedback (optional):</label>
                    <textarea name="feedback" rows="2" placeholder="Your feedback..."></textarea>
                </div>
                <button type="submit" class="btn-primary">Submit Rating</button>
            </form>
        </div>
        {% endif %}
    </div>
    {% else %}
    <div class="empty-state">
        <p>No refutations yet. Be the first to challenge this claim!</p>
        {% if can_refute %}
        <a href="{{ url_for('submit_refutation', bounty_id=bounty.id) }}" class="btn-primary">Submit Refutation</a>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endblock %}
